/*!
 * RCEditor
 * Another rich content editor based on UEditor
 * 
 * @author Dolphin Wood https://idiotwu.me
 * @version 0.0.2
 * Copyright 2015. MIT licensed.
 */
!function(a){"use strict";var b="rich-editor",c={name:"default",path:"/assets/editor/release/assets/themes/"},d={token:"/api/v2/others/upload-token",upload:"http://upload.qiniu.com",imgHost:"http://source.soyyin.com/"},e={UEDITOR_HOME_URL:location.href,toolbars:[["fullscreen","undo","redo","|","paragraph","fontsize","|","blockquote","horizontal","|","insertorderedlist","insertunorderedlist","|","selectall","cleardoc","removeformat","|","imgupload"],["bold","italic","underline","strikethrough","|","forecolor","backcolor","|","rowspacingtop","rowspacingbottom","lineheight","|","justifyleft","justifycenter","justifyright","justifyjustify","|","imagenone","imageleft","imagecenter","imageright"]],lang:"zh-cn",charset:"utf-8",enableContextMenu:!1,elementPathEnabled:!1,wordCount:!1,imagePopup:!1,theme:c.name,themePath:c.path,iframeCssUrl:c.path+c.name+"/css/iframe.css",insertorderedlist:{decimal:"","lower-alpha":"","lower-roman":"","upper-alpha":"","upper-roman":""},insertunorderedlist:{circle:"",disc:"",square:""}};a.RCEditor={editor:UE.getEditor(b,e),urlConfig:d,theme:c,imgWidth:838}}(window),function(a,b){"use strict";var c=(a.dom,a.browser),d=b.editor;c.webkit&&d.addListener("click",function(a,b){var c=b.target;if("IMG"==c.tagName){var e=d.selection.getRange();e.selectNode(c).select()}})}(window.UE,window.RCEditor),function(a,b){"use strict";var c=a.browser.ie9below?"innerText":"textContent";b.innerText=function(a,b){return void 0===b?a[c]:void(a[c]=b)}}(window.UE,window.RCEditor),function(a,b,c){"use strict";var d=a.uNode,e=(a.utils,b.editor),f=a.dom.domUtils,g=b.innerText,h=/(?:https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|www\.)[^\s]*/gi,i={9:"tab",13:"enter",32:"space"},j=function(a,b){var d=a.nodeValue,e=a.parentNode,i=0;d.replace(h,function(d,h){var j=d.length,k=a.splitText(h-i),l=c.createElement("a");return a=k.splitText(j),g(l,d),i=j+h,f.setAttributes(l,{href:/^www/.test(d)?"http://"+d:d,title:d,target:"_blank"}),b||(l.id="new-link"),e.replaceChild(l,k),""})},k=function(a,b,c){if(3===a.nodeType)return j(a);c=(c||a).childNodes;var d,e,f;for(d=0,e=c.length;e>d;d++)f=c[d],"A"===f.nodeName||f._hasMovedLink||(1===f.nodeType&&k(a,b,f),3===f.nodeType&&j(f,b))},l=function(b,f){if(b instanceof a.uNode){var g=b.toHtml(),h=c.createElement("div");if(h.innerHTML=g,k(h,!0),h.innerHTML===g)return;var i=d.createElement("div");i.innerHTML(h.innerHTML),b.children=void 0,b.appendChild(i),b.removeChild(i,!0)}else{k(b);var j=e.document.getElementById("new-link");if(j){j.removeAttribute("id");var l=this.selection.getRange();l.setEndAfter(j).collapse().select()}}},m=function(a){for(;a;){if(1===a.nodeType)return a;a=a.parentNode}};a.browser.ie||(e.addListener("keydown",function(a,b){var d=b.keyCode||b.which;if(i[d]){var g=e.selection.getRange(),h=g.startContainer;if(!f.findParentByTagName(h,"a",!0)){var j=m(h),k=c.createTextNode("");g.insertNode(k),l.call(e,j)}}}),e.addInputRule(function(a){var b=this.selection.getRange(),c=b.startContainer;f.findParentByTagName(c,"a",!0)||l.call(e,a)}))}(window.UE,window.RCEditor,document),function(a,b,c){"use strict";var d=a.utils,e=b.editor,f=a.dom.domUtils,g=b.innerText;e.ready(function(){var b=e.ui.getDom(),h=c.createElement("div"),i=c.createElement("div"),j=f.getXY(b),k=f.getXY(e.iframe);h.className="hide",h.id="link-editor-tip",i.id="link-editor",e.ui.getDom("iframeholder").style.zIndex="auto",h.innerHTML=['<div id="info-layer">','链接：<a id="link-info" target="_blank"></a>','<button id="open-editor">修改</button>','<button id="remove-link">移除</button>',"</div>"].join(""),i.innerHTML=['<div class="link-editor-layer">','<label for="link-address">链接地址：</label>','<input id="link-address" type="text">','</div><div class="link-editor-layer">','<label for="link-content">显示文字：</label>','<input id="link-content" type="text">',"</div>",'<button id="link-edit-save">保存</button>','<button id="link-edit-cancel">取消</button>'].join("");var l=h.querySelector("#link-info"),m=i.querySelector("#link-address"),n=i.querySelector("#link-content");h.appendChild(i),b.appendChild(h);var o=function(a){return a.length>25?a.slice(0,22)+"...":a},p=function(a){this.target=a};d.extend(p.prototype,{setPosition:function(){var a=this.target,b=f.getXY(a);f.setStyles(h,{top:b.y+k.y-j.y+a.offsetHeight+"px",left:b.x+k.x-j.x+"px"})},setInfo:function(){var a=this.target.href;l.href=l.title=a,g(l,o(a))},removeLink:function(){var b=this.target,d=b.firstChild,g=b.parentNode,h=c.createTextNode("​");if(g.replaceChild(d,b),f.insertAfter(d,h),this.target=h,a.browser.ie){var i=d.nodeValue.length,j=d.splitText(i/2|0);g.insertBefore(c.createTextNode("​"),j)}else d._hasMovedLink=!0;this.hide(!0),e.undoManger.save()},showEditor:function(){m.value=this.target.href,n.value=g(this.target),h.className="show editor-open"},saveEditor:function(){var a=this.target;a.href=m.value,a.title=n.value,g(a,n.value),this.hasEdited=!0,e.undoManger.save(),this.hide(!0)},restoreRange:function(){var a=e.selection.getRange();a.setEndAfter(this.target).collapse().select()},show:function(){this.setInfo(),this.setPosition(),h.className="show"},hide:function(a){h.className="hide",a&&this.restoreRange()}});var q,r,s=function(){r&&(r.hide(),r=null)};e.addListener("selectionchange",function(){var a=e.selection.getRange(),b=a.startContainer;if(0===a.startOffset&&a.collapsed)return s();var c=f.findParentByTagName(b,"a",!0);return c?((b!==q||!r||r.hasEdited)&&(r=new p(c),q=b),void r.show()):s()}),f.on(h,"click",function(a){a=a||window.event;var b=a.target||a.srcElement;if(r&&"BUTTON"===b.tagName){var c=b.id;switch(c){case"open-editor":return r.showEditor();case"remove-link":return r.removeLink();case"link-edit-save":return r.saveEditor();case"link-edit-cancel":return r.hide(!0)}}}),f.on(i,"keydown",function(a){a=a||window.event;var b=a.target||a.srcElement;if("INPUT"===b.tagName){var c=a.keyCode||a.which;return 13===c?r&&r.saveEditor():void 0}})})}(window.UE,window.RCEditor,document),function(a,b,c,d){"use strict";var e=b.editor,f=a.dom.domUtils,g=b.innerText,h=c.localStorage,i=location.hash;if(h&&i.match(/auto_save/)){var j,k,l="auto_save",m=l+"_draft",n=l+"_save_time",o=d.createElement("div"),p={year:31536e3,day:86400,hour:3600,minute:60},q=function(a){return a>p.year?(a/p.year|0)+" 年前":a>p.day?(a/p.day%365|0)+" 天前":a>p.hour?(a/p.hour%24|0)+" 小时前":a>p.minute?(a/p.minute%60|0)+" 分钟前":a%60+" 秒前"},r=function(){var a=e.getContent(),b=new Date;h.setItem(m,a),h.setItem(n,b.getTime()),g(o,"自动保存于 "+b.toLocaleString())},s=function(){var a=h.getItem(m),b=h.getItem(n);if(a){e.body.innerHTML=a;var c=(new Date).getTime(),d=q((c-b)/1e3|0);g(o,"已载入保存于 "+d+"的草稿")}},t=1e4;e.addListener("ready",function(){var a=e.container,b=a.parentNode;o.id="auto-save-info",b.appendChild(o),s()}),e.addListener("contentchange",function(){var a=(new Date).getTime();return!j||a-j>t?(clearTimeout(k),k=void 0,j=a,void r()):void(k||(k=setTimeout(function(){j=(new Date).getTime(),k=void 0,r()},t)))});var u;e.addListener("submitsuccess",function(){u=!0,h.removeItem(m)}),f.on(c,"hashchange beforeunload",function(){u||r()})}}(window.UE,window.RCEditor,window,document),function(a,b,c,d){"use strict";var e=b.editor,f=a.ajax.request,g=a.dom.domUtils,h=b.urlConfig,i="FormData"in window,j=d.createElement("form"),k=d.createElement("iframe"),l=b.theme.path+b.theme.name,m={};k.id=k.name="image-uploader",k.style.display="none",g.setAttributes(j,{method:"POST",target:"image-uploader",action:h.upload,enctype:"multipart/form-data"}),j.innerHTML=['<input type="file" accept="image/*" name="file" id="upload-image" multiple>','<input name="accept" type="hidden" value="text/plain; charset=utf-8">','<input name="x:timestamp" type="hidden" id="time-stamp">','<input type="hidden" name="token" id="upload-token">','<input type="hidden" name="key" id="upload-key">'].join("");var n=j.querySelector("#upload-image"),o=j.querySelector("#upload-token"),p=j.querySelector("#upload-key"),q=j.querySelector("#time-stamp"),r=function(a){e.fireEvent("errormsg","上传失败："+a)},s=function(a){var b=m[a].target;b&&(b.src=l+"/images/upload-failed.jpg",b.title="图片上传失败",delete m[a]),j.reset(),r("图片上传失败")},t=function(a,c){var d=m[a].target;c&&d?(d.src=h.imgHost+c.key+"?imageView/2/w/"+b.imgWidth,e.undoManger.save(),delete m[a]):s(a)},u=function(a,b,c){i&&c?(c.append("token",a.token),c.append("key",a.key),c.append("x:timestamp",b)):(o.value=a.token,p.value=a.key,q.value=b)},v=function(a){var b;try{b=JSON.parse(a)}catch(c){return r(c)}return b},w=function(a){var b=h.token;f(b,{method:"GET",async:!0,onsuccess:function(b){var c=b.responseText,d=v(c);e.fireEvent("tokenload",a,d)},onerror:function(){s(a),r("签发服务器通信失败")}})},x=function(a,b){{var c=new XMLHttpRequest;m[a].target}c.open("POST",h.upload,!0),c.onreadystatechange=function(){if(4===c.readyState)if(200==c.status){var b=v(c.responseText);t(a,b)}else s(a)},c.send(b)},y=function(){var a=d.createElement("img"),b=e.selection.getRange();return a.src=l+"/images/ajax-loader.gif",b.insertNode(a).collapse().select(),a},z=function(a){var b=(new Date).getTime().toString(32);m[b]={target:y(),file:a},w(b)};e.addListener("tokenload",function(a,b,c){if(i){var d=new FormData,e=m[b].file;u(c,b,d),d.append("file",e||n.files[0]),x(b,d)}else u(c,b),j.submit();j.reset()}),e.addListener("imageselect",function(){n.click()}),g.on(n,"change",function(){if(n.value)if(i)[].slice.call(n.files).forEach(function(a){return a.type.match(/image.*/)?void z(a):r("不支持的文件类型 "+a.name)});else{if(!n.value.match(/\.(?:jpg|jpeg|png|gif|bmp)$/i))return r("不支持的文件类型 "+n.value);z()}}),e.ready(function(){if(!i){var b=d.querySelector(".edui-for-imgupload .edui-icon");b.appendChild(k),b.appendChild(j),g.on(k,"load",function(){if(!a.utils.isEmptyObject(m)){var b=k.contentDocument||k.contentWindow.document,d=b.location.search;if(!d)return r("图片上传失败");var e=v(c.decode(d.replace("?upload_ret=",""))),f=e["x:timestamp"];t(f,e)}})}}),b.imgUploader=z}(window.UE,window.RCEditor,window.Base64,document),function(a,b,c){"use strict";if(window.FormData&&window.FileReader){var d=b.editor,e=b.imgUploader,f=a.dom.domUtils;d.ready(function(){var a=d.body,b=function(b){var c,f;if(a.classList.remove("drop"),b.clipboardData?c=b.clipboardData.items||b.clipboardData.files:b.dataTransfer&&(c=b.dataTransfer.files),c){for(var g=0,h=c.length;h>g;g++){var i=c[g];i.getAsFile&&(i=i.getAsFile()),i&&i.size>0&&(f=!0,i.type.match(/image.*/)?e(i):d.fireEvent("errormsg","不支持的文件类型："+i.name))}f&&b.preventDefault()}},g=function(b,c){var d=b.dataTransfer,e=d.types;e[0].match(/file/i)&&(b.preventDefault(),d.dropEffect="copy",c&&a.classList.add("drop"))};f.on(a,"paste drop",b),f.on(c,"drop",b),a.addEventListener("dragover",g),c.addEventListener("dragover",g),a.addEventListener("click",function(){a.classList.remove("drop")}),a.addEventListener("dragenter",function(a){g(a,!0)}),c.addEventListener("dragenter",function(a){g(a,!0)})})}}(window.UE,window.RCEditor,document),function(a,b){"use strict";var c=b.editor,d=a.utils,e=b.theme.path+b.theme.name+"/images/local-image.jpg";c.addInputRule(function(a){d.each(a.getNodesByTagName("img"),function(a){var b=a.attrs.src;b&&b.match(/^(?:(file:\/+))/i)&&(a.setAttr({src:e,_src:e}),c.fireEvent("errormsg","包含本地图片，请重新上传！"))})})}(window.UE,window.RCEditor),function(a,b){"use strict";var c=b.editor,d=a.utils;c.addInputRule(function(a){d.each(a.getNodesByTagName("img"),function(a){var b=a.attrs.src,c=a.attrs["data-src"];!b&&c&&(a.setAttr("src",c),a.setStyle({height:"auto !important",visibility:"visible !important"}))})})}(window.UE,window.RCEditor),function(a,b){"use strict";var c=b.editor,d=a.utils;c.addInputRule(function(a){d.each(a.getNodesByTagName("img"),function(a){a.setStyle({width:"auto",height:"auto","max-width":"100%"})})})}(window.UE,window.RCEditor),function(a,b){"use strict";var c=a.editor,d=a.innerText;c.ready(function(){var a,e=c.ui.getDom("toolbarbox"),f=b.createElement("div");f.id="editor-error",e.appendChild(f),c.addListener("errormsg",function(b,c){c&&(a&&clearTimeout(a),d(f,c),f.className="show",a=setTimeout(function(){f.className="",a=void 0},2500))})})}(window.RCEditor,document),function(a){"use strict";var b=a.editor,c=function(a){return a?(a=a.toString(),b.isReady?b.setContent(a):void b.ready(function(){b.setContent(a)})):void 0},d=function(){return b.getContent()};a.setContent=c,a.getContent=d}(window.RCEditor);